<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <title>Markdown Editor Pro+</title>

    <!-- Markdown æ ·å¼ -->
    <link id="markdownTheme" rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css">

    <!-- ä»£ç é«˜äº® -->
    <link rel="stylesheet" id="codeTheme"
          href="https://cdn.jsdelivr.net/npm/highlight.js/styles/github.min.css">
    <script src="https://cdn.jsdelivr.net/npm/highlight.js/highlight.min.js"></script>

    <!-- Marked -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- KaTeX -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex/dist/contrib/auto-render.min.js"></script>

    <!-- Mermaid -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>

    <!-- PDF -->
    <script src="https://cdn.jsdelivr.net/npm/html2pdf.js/dist/html2pdf.bundle.min.js"></script>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- html2canvas for download -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <style>
        body {
            margin: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI";
        }

        .toolbar {
            display: flex;
            padding: 8px;
            border-bottom: 1px solid #ddd;
            background: #f6f8fa;
        }

        .toolbar-left {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            padding: 6px 12px;
            border: 1px solid #d0d7de;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #24292f;
            transition: all 0.2s;
        }

        button:hover {
            background: #f3f4f6;
            border-color: #babbbd;
        }

        button:active {
            background: #ebecf0;
        }

        #modeBtn {
            min-width: 100px;
        }

        .dark button {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .dark button:hover {
            background: #30363d;
            border-color: #484f58;
        }

        select {
            padding: 6px 12px;
            border: 1px solid #d0d7de;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            color: #24292f;
        }

        select:hover {
            border-color: #babbbd;
        }

        .dark select {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .dark select:hover {
            border-color: #484f58;
        }

        #currentFileName {
            font-size: 14px;
            color: #666;
            max-width: 300px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .editor-container {
            width: 40%;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #ddd;
            overflow: hidden;
            min-height: 0;
        }

        /* ç¼–è¾‘åŒºåŸŸ */
        .editor-area {
            flex: 1;
            display: flex;
            overflow: hidden;
            border: 1px solid #eee;
            font-family: Consolas, Courier;
        }

        .editor-area:focus-within {
            border-color: #5d5d5d;
        }

        /* è¡Œå· */
        .line-numbers {
            padding: 10px 0 50px 0;
            border-right: 1px solid #ccc;
            background: #eeeeee;
            text-align: right;
            min-width: 2rem;
            font-family: Consolas, Courier;
            font-size: 16px;
            line-height: 1.5;
            overflow: hidden;
            user-select: none;
        }

        .line-numbers span {
            display: block;
            width: 100%;
            text-align: right;
            padding-left: 5px;
            padding-right: 5px;
        }

        .line-numbers .selected {
            color: blue;
            background-color: #bdd5e3;
        }

        .dark .line-numbers {
            background: #161b22;
            border-color: #30363d;
        }

        .dark .line-numbers .selected {
            background-color: #1f3d2a;
            color: #58a6ff;
        }

        /* ç¼–è¾‘å™¨æ–‡æœ¬æ¡† */
        #editor {
            flex: 1;
            border: none;
            outline: none;
            resize: none;
            padding: 10px;
            font-family: Consolas, Courier;
            font-size: 16px;
            line-height: 1.8;
            white-space: nowrap;
            overflow: auto;
            background-color: #ffffff;
        }

        /* åº•éƒ¨çŠ¶æ€æ  */
        .foot-bar {
            display: flex;
            justify-content: space-around;
            font-size: 12px;
            color: #666;
            background: #f6f8fa;
            padding: 8px;
            border-top: 1px solid #ddd;
            white-space: nowrap;
            flex-shrink: 0;
            line-height: 1.5;
        }

        .foot-bar span {
            margin: 0 8px;
        }

        .dark .foot-bar {
            background: #161b22;
            color: #8b949e;
            border-color: #30363d;
        }

        /* ç¼–è¾‘å™¨å’Œé¢„è§ˆå·¥å…·æ  */
        .editor-preview-toolbar {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 10px;
            background: #f6f8fa;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
            flex-wrap: wrap;
        }

        .dark .editor-preview-toolbar {
            background: #161b22;
            border-color: #30363d;
        }

        /* å·¥å…·æ æŒ‰é’® */
        .btn-control {
            padding: 4px 8px;
            border: 1px solid #d0d7de;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #24292f;
            transition: all 0.2s;
        }

        .btn-control:hover {
            background: #f3f4f6;
            border-color: #babbbd;
        }

        .btn-p-sm {
            padding: 2px 6px;
            font-size: 12px;
        }

        .btn-p-xxs {
            padding: 1px 4px;
            font-size: 11px;
        }

        .dark .btn-control {
            background: #21262d;
            border-color: #30363d;
            color: #c9d1d9;
        }

        .dark .btn-control:hover {
            background: #30363d;
            border-color: #484f58;
        }

        /* é€‰ä¸­çŠ¶æ€ */
        .btn-control[data-select="true"] {
            background: #e6f2ff;
            border-color: #0066cc;
            color: #0066cc;
        }

        .dark .btn-control[data-select="true"] {
            background: #1f3d2a;
            border-color: #238636;
            color: #3fb950;
        }

        /* å­—æ¯å›¾æ ‡ */
        .letter-icon {
            font-weight: bold;
            font-size: 14px;
        }

        /* åŒæ­¥æ»šåŠ¨å›¾æ ‡ */
        .sync-scrolling-icon i {
            border-left: 2px solid #c1c1c1;
            border-right: 2px solid #c1c1c1;
            padding: 0 2px;
        }

        .sync-scrolling-icon[data-select="true"] i {
            border-color: #0066cc;
        }

        .dark .sync-scrolling-icon i {
            border-color: #484f58;
        }

        .dark .sync-scrolling-icon[data-select="true"] i {
            border-color: #238636;
        }

        /* Bootstrap å·¥å…·ç±» */
        .ms-auto {
            margin-left: auto;
        }

        .mx-1 {
            margin-left: 4px;
            margin-right: 4px;
        }

        .min-w-2rem {
            min-width: 2rem;
        }

        .max-w-200px {
            max-width: 200px;
        }

        .text-black-50 {
            color: rgba(0, 0, 0, 0.5);
        }

        .d-inline-block {
            display: inline-block;
        }

        .d-none {
            display: none !important;
        }

        /* æš—è‰²ä¸»é¢˜ä¸‹çš„æ–‡æœ¬é¢œè‰² */
        .dark .text-black-50 {
            color: rgba(255, 255, 255, 0.5);
        }

        .editor-toolbar {
            display: flex;
            gap: 8px;
            padding: 8px;
            background: #f6f8fa;
            border-bottom: 1px solid #ddd;
            flex-shrink: 0;
        }

        .dark .editor-toolbar {
            background: #161b22;
            border-color: #30363d;
        }

        .editor-toolbar button {
            padding: 4px 8px;
            font-size: 12px;
            min-width: 32px;
        }

        .dark #currentFileName {
            color: #8b949e;
        }

        .toolbar-right {
            margin-left: auto;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .container {
            flex: 1;
            display: flex;
            overflow: hidden;
            position: relative;
            height: 100vh;
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 0;
        }

        .toc {
            width: 220px;
            overflow: auto;
            border-right: 1px solid #ddd;
            padding: 10px;
            background: #fafafa;
            flex-shrink: 0;
        }

        .toc-hidden {
            display: none !important;
        }

        /* ç›®å½•é¡¹ */
        .toc-item {
            display: block;
            text-decoration: none;
            font-size: 14px;
            padding: 2px 5px;
            color: #0366d6;
            cursor: pointer;
            white-space: nowrap;
        }

        .toc-item:hover {
            background-color: #eeeeee;
        }

        /* ç›®å½•é¡¹å›¾æ ‡ - ä½¿ç”¨ Bootstrap Icons */
        .toc-item::before {
            display: inline-block;
            font-family: bootstrap-icons !important;
            font-style: normal;
            font-weight: normal !important;
            font-variant: normal;
            text-transform: none;
            line-height: 1;
            vertical-align: -.125em;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            padding-right: 5px;
            color: #9696cb;
        }

        .toc-item[data-level="1"]::before {
            content: "\f5f1"; /* H1 icon */
        }

        .toc-item[data-level="2"]::before {
            content: "\f5f2"; /* H2 icon */
            margin-left: 0.5rem;
        }

        .toc-item[data-level="3"]::before {
            content: "\f5f3"; /* H3 icon */
            margin-left: 1rem;
        }

        .toc-item[data-level="4"]::before {
            content: "\f8dc"; /* H4 icon */
            margin-left: 1.5rem;
        }

        .toc-item[data-level="5"]::before {
            content: "\f8dd"; /* H5 icon */
            margin-left: 2rem;
        }

        .toc-item[data-level="6"]::before {
            content: "\f8de"; /* H6 icon */
            margin-left: 2.5rem;
        }

        .editor {
            width: 100%;
            border: none;
            padding: 16px;
            resize: none;
            outline: none;
            font-family: monospace;
            flex: 1;
            overflow: auto;
        }

        .preview-wrapper {
            width: 60%;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding: 0;
            min-height: 0;
        }

        .preview-content-wrapper {
            flex: 1;
            min-height: 0;
            overflow: auto;
            padding: 0;
        }

        .markdown-body {
            max-width: 1020px;
            margin-left: auto;
            margin-right: auto;
            font-size: 16px;
            line-height: 1.8;
            padding: 1rem;
            background-color: #ffffff;
        }

        .markdown-content {
            margin-left: auto;
            margin-right: auto;
            min-height: 100%;
            font-size: 16px;
            line-height: 1.8;
        }

        /* æ‹–åŠ¨æ¡å®¹å™¨ */
        .resizer-container {
            width: 12px;
            display: flex;
            flex-direction: column;
            flex-shrink: 0;
            background: #ddd;
        }

        /* æ‹–åŠ¨æ¡é¡¶éƒ¨æŒ‰é’® */
        .resizer-top {
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #ddd;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resizer-top:hover {
            background: #bacce0;
        }

        /* æ‹–åŠ¨æ¡ä¸­é—´åŒºåŸŸ */
        .resizer-mid {
            flex: 1;
            cursor: col-resize;
            background: #ddd;
            min-height: 0;
        }

        .resizer-mid:hover {
            background: #bacce0;
        }

        /* æ‹–åŠ¨æ¡åº•éƒ¨æŒ‰é’® */
        .resizer-bottom {
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            background: #ddd;
            flex-shrink: 0;
            transition: background 0.2s;
        }

        .resizer-bottom:hover {
            background: #bacce0;
        }

        /* æš—è‰²ä¸»é¢˜ */
        .dark .resizer-container,
        .dark .resizer-top,
        .dark .resizer-mid,
        .dark .resizer-bottom {
            background: #30363d;
        }

        .dark .resizer-top:hover,
        .dark .resizer-mid:hover,
        .dark .resizer-bottom:hover {
            background: #484f58;
        }

        .resizer-container {
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        .resizing {
            cursor: col-resize !important;
        }

        .dark {
            background: #0d1117;
            color: #c9d1d9;
        }

        .dark .toolbar {
            background: #161b22;
            border-color: #30363d;
        }

        .dark .toc {
            background: #161b22;
            border-color: #30363d;
        }

        .dark textarea {
            background: #0d1117;
            color: #c9d1d9;
            border-color: #30363d;
        }

        .dark #editor {
            background-color: #0d1117;
        }

        .dark .markdown-body {
            background-color: #0d1117;
        }

        .dark .resizer {
            background: #30363d;
        }

        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%) translateY(-20px);
            background: #3c3c3c;
            color: white;
            padding: 8px 16px;
            border-radius: 4px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s, transform 0.3s;
            font-size: 13px;
        }

        .toast.show {
            opacity: 0.9;
            transform: translateX(-50%) translateY(0);
        }

        .toast.success {
            background: #28a745;
        }

        .toast.error {
            background: #dc3545;
        }

        .dark .toast {
            background: #21262d;
            color: #c9d1d9;
        }

        .dark .toast.success {
            background: #238636;
        }

        .dark .toast.error {
            background: #da3633;
        }

        @media print {
            body {
                background: white;
                height: auto;
                overflow: visible;
            }

            /* éšè—ä¸éœ€è¦æ‰“å°çš„å…ƒç´  */
            .toolbar,
            .toolbar-left,
            .toolbar-right,
            .toc,
            .editor-container,
            #editor,
            .line-numbers,
            .editor-preview-toolbar,
            .resizer-container,
            .resizer-top,
            .resizer-mid,
            .resizer-bottom,
            #toast,
            .foot-bar {
                display: none !important;
            }

            /* éšè—ç¼–è¾‘å™¨éƒ¨åˆ† */
            .editor-area,
            #editorToolbar,
            .editor-toolbar {
                display: none !important;
            }

            /* æ˜¾ç¤ºé¢„è§ˆå†…å®¹ */
            .preview-content-wrapper {
                display: block !important;
                overflow: visible !important;
            }

            .container {
                display: block;
                height: auto;
                overflow: visible;
                width: 100%;
            }

            .preview-wrapper {
                width: 100%;
                margin: 0;
                padding: 0;
                height: auto;
                overflow: visible;
                display: block;
                border: none;
                flex-direction: column;
            }

            #previewToolbar {
                display: none !important;
            }

            .markdown-body {
                max-width: 100%;
                padding: 20px;
                height: auto;
                overflow: visible;
                margin: 0;
                background: white !important;
            }

            .markdown-content {
                margin: 0;
                padding: 0;
            }

            h1, h2, h3, h4, h5, h6 {
                page-break-after: avoid;
            }

            p, pre, blockquote {
                page-break-inside: avoid;
            }

            table, img {
                page-break-inside: avoid;
            }
        }
    </style>
</head>

<body>

<div id="toast" class="toast"></div>

<div class="toolbar">
    <div class="toolbar-left">
        <button onclick="toggleTOC()">ğŸ“‘ ç›®å½•</button>
        <button onclick="newFile()">ğŸ“„ æ–°å»º</button>
        <button onclick="saveFile()">ğŸ’¾ ä¿å­˜</button>
        <button onclick="openFile()">ğŸ“‚ æ‰“å¼€</button>
        <span id="currentFileName">æœªå‘½åæ–‡ä»¶</span>
    </div>
    <div class="toolbar-right">
        <select onchange="changeTheme(this.value)">
            <option value="github">GitHub</option>
            <option value="dark">Dark</option>
            <option value="solarized">Solarized</option>
        </select>
        <button id="modeBtn" onclick="toggleMode()">ğŸ‘ é¢„è§ˆ</button>
        <button onclick="printDocument()">ğŸ–¨ æ‰“å°</button>
        <button onclick="exportPDF()">ğŸ“• å¯¼å‡º PDF</button>
    </div>
</div>

<div class="container">
    <div class="toc" id="toc"></div>

<script>
    /* é˜²æŠ–å‡½æ•° */
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
</script>

    <div class="editor-container">
        <!--ç¼–è¾‘å·¥å…·æ -->
        <div id="editorToolbar" class="editor-preview-toolbar">
            <!--ç²—ä½“-->
            <button id="tb-bold" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="åŠ ç²—<br><b>Ctrl+B</b>">
                <i class="bi bi-type-bold"></i>
            </button>
            <!--æ–œä½“-->
            <button id="tb-italic" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="æ–œä½“<br><b>Ctrl+I</b>">
                <i class="bi bi-type-italic"></i>
            </button>
            <!--ä¸‹åˆ’çº¿-->
            <button id="tb-underline" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="ä¸‹åˆ’çº¿<br><b>Ctrl+U</b>">
                <i class="bi bi-type-underline"></i>
            </button>
            <!--åˆ é™¤çº¿-->
            <button id="tb-strikethrough" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="åˆ é™¤çº¿<br><b>Ctrl+Shift+S</b>">
                <i class="bi bi-type-strikethrough"></i>
            </button>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--æ ‡é¢˜ -->
            <div class="dropdown d-inline-block">
                <div data-bs-toggle="dropdown" aria-expanded="false">
                    <button id="tb-headline" class="btn btn-control btn-p-sm dropdown-toggle"
                            data-bs-toggle="tooltip" data-bs-placement="bottom"
                            title="æ ‡é¢˜<br><b> Ctrl+[1~6]</b>">
                        <i class="bi bi-type-h1"></i>
                    </button>
                </div>
                <ul id="tb-headline-ul" class="dropdown-menu min-w-2rem">
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="1">
                            <i class="bi bi-type-h1"></i> ä¸€çº§æ ‡é¢˜
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="2">
                            <i class="bi bi-type-h2"></i> äºŒçº§æ ‡é¢˜
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="3">
                            <i class="bi bi-type-h3"></i> ä¸‰çº§æ ‡é¢˜
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="4">
                            <i class="bi bi-type-h4"></i> å››çº§æ ‡é¢˜
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="5">
                            <i class="bi bi-type-h5"></i> äº”çº§æ ‡é¢˜
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item" data-level="6">
                            <i class="bi bi-type-h6"></i> å…­çº§æ ‡é¢˜
                        </button>
                    </li>
                </ul>
            </div>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--æ°´å¹³çº¿-->
            <button id="tb-horizontal-line" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="æ°´å¹³çº¿">
                <i class="bi bi-dash-lg"></i>
            </button>
            <!--å¼•ç”¨-->
            <button id="tb-quote" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="å¼•ç”¨<br><b>Ctrl+Shift+Q</b>">
                <i class="bi bi-blockquote-left"></i>
            </button>
            <!--æ— åºåˆ—è¡¨-->
            <button id="tb-unordered-list" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="æ— åºæ ‡é¢˜<br><b>Ctrl+Shift+[</b>">
                <i class="bi bi-list-ul"></i>
            </button>
            <!--æœ‰åºåˆ—è¡¨-->
            <button id="tb-ordered-list" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="æœ‰åºæ ‡é¢˜<br><b>Ctrl+Shift+]</b>">
                <i class="bi bi-list-ol"></i>
            </button>
            <!--æœªå‹¾é€‰-->
            <button id="tb-task-uncheck" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="ä»»åŠ¡åˆ—è¡¨-æœªå‹¾é€‰">
                <i class="bi bi-square"></i>
            </button>
            <!--å·²ç»å‹¾é€‰-->
            <button id="tb-task-check" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="ä»»åŠ¡åˆ—è¡¨-å·²å‹¾é€‰">
                <i class="bi bi-check-square"></i>
            </button>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--è¡¨æ ¼-->
            <button id="tb-table" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="è¡¨æ ¼<br><b>Ctrl+Shift+T</b>">
                <i class="bi bi-table"></i>
            </button>
            <!--å›¾ç‰‡-->
            <button id="tb-image" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="å›¾ç‰‡">
                <i class="bi bi-image"></i>
            </button>
            <!--é“¾æ¥-->
            <button id="tb-link" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="é“¾æ¥">
                <i class="bi bi-link-45deg"></i>
            </button>
            <!--å†…åµŒä»£ç -->
            <button id="tb-inner-code" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="å†…åµŒä»£ç ">
                <i class="bi bi-code"></i>
            </button>
            <!--ä»£ç å—-->
            <button id="tb-code" class="btn btn-control btn-p-sm" data-bs-toggle="tooltip"
                    data-bs-placement="bottom" title="ä»£ç å—">
                <i class="bi bi-code-square"></i>
            </button>

            <!--å³ä¾§æŒ‰é’®ç»„-->
            <!--å­—ä½“å¤§å°-->
            <button id="tb-font-decrease" onclick="decreaseFontSize()" class="btn btn-control btn-p-sm ms-auto"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="ç¼©å°å­—ä½“">
                <i class="bi bi-fonts"></i>-
            </button>
            <button id="tb-font-increase" onclick="increaseFontSize()" class="btn btn-control btn-p-sm"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="æ”¾å¤§å­—ä½“">
                <i class="bi bi-fonts"></i>+
            </button>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰²ä¸‹æ‹‰æ¡†-->
            <div class="dropdown d-inline-block">
                <div data-bs-toggle="dropdown" aria-expanded="false">
                    <button id="tb-bgColor" class="btn btn-control btn-p-sm dropdown-toggle"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰²">
                        <i class="bi bi-palette"></i>
                    </button>
                </div>

                <ul id="editor-color-dropdown" class="dropdown-menu max-w-200px">
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-secondary-subtle editor-bg-color"
                                data-color="#e2e3e5" data-color-dark="#2d2d2d">
                            æµ…ç°è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-primary-subtle editor-bg-color"
                                data-color="#cfe2ff" data-color-dark="#1a3355">
                            æµ…è“è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-success-subtle editor-bg-color"
                                data-color="#d1e7dd" data-color-dark="#1a331a">
                            æµ…ç»¿è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-warning-subtle editor-bg-color"
                                data-color="#fff3cd" data-color-dark="#332d1f">
                            æµ…é»„è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-info-subtle editor-bg-color"
                                data-color="#cff4fc" data-color-dark="#1a3355">
                            è“ç»¿è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item editor-bg-color" data-color=""
                                data-color-dark="">
                            æ— èƒŒæ™¯
                        </button>
                    </li>
                </ul>
            </div>
        </div>
        <div class="editor-area">
            <div class="line-numbers" id="lineNumbers">
                <span class="selected">1</span>
            </div>
            <textarea id="editor" class="editor"># ç¤ºä¾‹æ–‡æ¡£

## Mermaid ç¤ºä¾‹

```mermaid
graph TD
A-->B
B-->C
```
## æ•°å­¦å…¬å¼

$E=mc^2$</textarea>
        </div>
        <div class="foot-bar">
            <span>å­—ç¬¦ï¼š<b id="charCount">0</b></span>
            <span>è¡Œæ•°ï¼š<b id="lineCount">0</b></span>
            <span>å…‰æ ‡ï¼š<b id="cursorLine">0</b> è¡Œ <b id="cursorCol">0</b> åˆ—</span>
        </div>
    </div>

    <!-- æ‹–åŠ¨æ¡ -->
    <div class="resizer-container">
        <!-- é¡¶éƒ¨æŒ‰é’®ï¼šæŠ˜å é¢„è§ˆ -->
        <div class="resizer-top" id="resizerTop" title="æŠ˜å é¢„è§ˆåŒºåŸŸ">
            <i class="bi bi-caret-right" id="resizerTopIcon"></i>
        </div>
        <!-- ä¸­é—´æ‹–åŠ¨åŒºåŸŸ -->
        <div class="resizer-mid" id="resizerMid"></div>
        <!-- åº•éƒ¨æŒ‰é’®ï¼šéšè—çŠ¶æ€æ  -->
        <div class="resizer-bottom" id="resizerBottom" title="éšè—çŠ¶æ€æ ">
            <i class="bi bi-chevron-down" id="resizerBottomIcon"></i>
        </div>
    </div>

    <div class="preview-wrapper">
        <!--é¢„è§ˆå·¥å…·æ -->
        <div id="previewToolbar" class="editor-preview-toolbar">
            <button id="p-tb-small" class="btn btn-control btn-p-sm ms-auto"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="å®½åº¦ è¾ƒçª„">
                <span class="letter-icon">S</span>
            </button>
            <button id="p-tb-middle" class="btn btn-control btn-p-sm" data-select="true"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="å®½åº¦ ä¸­ç­‰">
                <span class="letter-icon">M</span>
            </button>
            <button id="p-tb-large" class="btn btn-control btn-p-sm"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="å®½åº¦ è¾ƒå®½">
                <span class="letter-icon">L</span>
            </button>
            <button id="p-tb-full" class="btn btn-control btn-p-sm"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="å®½åº¦ æ‹‰æ»¡">
                <span class="letter-icon">F</span>
            </button>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--èƒŒæ™¯é¢œè‰²ä¸‹æ‹‰æ¡†-->
            <div class="dropdown d-inline-block">
                <div data-bs-toggle="dropdown" aria-expanded="false">
                    <button id="p-tb-bgColor" class="btn btn-control btn-p-sm dropdown-toggle"
                            data-bs-toggle="tooltip" data-bs-placement="bottom" title="èƒŒæ™¯é¢œè‰²">
                        <i class="bi bi-palette"></i>
                    </button>
                </div>

                <ul id="tb-color-dropdown" class="dropdown-menu max-w-200px">
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-secondary-subtle"
                                data-color="#e2e3e5">
                            æµ…ç°è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-primary-subtle"
                                data-color="#cfe2ff">
                            æµ…è“è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-success-subtle"
                                data-color="#d1e7dd">
                            æµ…ç»¿è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-warning-subtle"
                                data-color="#fff3cd">
                            æµ…é»„è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item bg-info-subtle"
                                data-color="#cff4fc">
                            è“ç»¿è‰²
                        </button>
                    </li>
                    <li>
                        <button class="btn btn-control btn-p-sm dropdown-item " data-color="">
                            æ— èƒŒæ™¯
                        </button>
                    </li>
                </ul>
            </div>

            <!--åˆ†éš”-->
            <span class="text-black-50 mx-1">|</span>

            <!--ä¸‹è½½-->
            <button id="p-tb-download" class="btn btn-control btn-p-sm"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="ä¸‹è½½æ–‡æ¡£å›¾ç‰‡">
                <i class="bi bi-image"></i>
            </button>

            <!--å…¨å±-->
            <button id="p-tb-fullscreen" class="btn btn-control btn-p-sm"
                    data-bs-toggle="tooltip" data-bs-placement="bottom" title="å†…å®¹å…¨å±">
                <i class="bi bi-arrows-fullscreen"></i>
            </button>

            <!--åŒæ­¥æ»šåŠ¨-->
            <button id="tb-syncScroll" class="btn btn-control btn-p-sm ms-auto sync-scrolling-icon"
                    data-select="true" data-bs-toggle="tooltip" data-bs-placement="bottom" title="åŒæ­¥æ»šåŠ¨">
                <i class="bi bi-arrows-vertical"></i>
            </button>
        </div>

        <!-- é¢„è§ˆå†…å®¹å®¹å™¨ -->
        <div class="preview-content-wrapper">
            <article id="preview" class="markdown-body markdown-content"></article>
        </div>

        <!-- é¢„è§ˆåº•éƒ¨çŠ¶æ€æ  -->
        <div class="foot-bar">
            <span>æ ‡é¢˜ï¼š<b id="headCount">0</b></span>
            <span>æ®µè½ï¼š<b id="paraCount">0</b></span>
            <span>ä»£ç å—ï¼š<b id="codeCount">0</b></span>
            <span>å›¾ç‰‡ï¼š<b id="imgCount">0</b></span>
        </div>
    </div>
</div>
<script>
    mermaid.initialize({startOnLoad: false});

    const editor = document.getElementById("editor");
    const preview = document.getElementById("preview");
    const previewContentWrapper = document.querySelector(".preview-content-wrapper");
    const toc = document.getElementById("toc");

    let currentMode = "edit";
    let isTOCVisible = true;
    let currentFileHandle = null;
    let isSyncScroll = localStorage.getItem("syncScroll") !== "false";  // é»˜è®¤å¼€å¯
    let lineNumberCounter = 1;
    let selectedLineNumber = 1;

    // è·å–è¡Œå·å…ƒç´ 
    const lineNumbers = document.getElementById("lineNumbers");

    // åˆå§‹åŒ–åŒæ­¥æ»šåŠ¨æŒ‰é’®çŠ¶æ€
    const syncScrollBtn = document.getElementById("tb-syncScroll");
    if (syncScrollBtn) {
        syncScrollBtn.dataset.select = isSyncScroll ? "true" : "false";
    }

    // åˆå§‹åŒ– Bootstrap Tooltips
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        new bootstrap.Tooltip(el, {
            delay: {show: 500, hide: 100},
            html: true
        });
    });

    // ç»‘å®šå·¥å…·æ æŒ‰é’®äº‹ä»¶
    bindEditorToolbarEvents();
    bindPreviewToolbarEvents();

    /* ç¼–è¾‘å™¨å·¥å…·æ äº‹ä»¶ç»‘å®š */
    function bindEditorToolbarEvents() {
        // ç²—ä½“
        document.getElementById("tb-bold").onclick = boldAction;
        // æ–œä½“
        document.getElementById("tb-italic").onclick = italicAction;
        // ä¸‹åˆ’çº¿
        document.getElementById("tb-underline").onclick = underlineAction;
        // åˆ é™¤çº¿
        document.getElementById("tb-strikethrough").onclick = strikethroughAction;
        // æ ‡é¢˜ä¸‹æ‹‰èœå•
        document.getElementById("tb-headline-ul").onclick = function(e) {
            const level = e.target.closest("[data-level]")?.dataset.level;
            if (level) {
                insertHeadline(parseInt(level));
            }
        };
        // æ°´å¹³çº¿
        document.getElementById("tb-horizontal-line").onclick = horizontalLineAction;
        // å¼•ç”¨
        document.getElementById("tb-quote").onclick = quoteAction;
        // æ— åºåˆ—è¡¨
        document.getElementById("tb-unordered-list").onclick = unorderedListAction;
        // æœ‰åºåˆ—è¡¨
        document.getElementById("tb-ordered-list").onclick = orderedListAction;
        // ä»»åŠ¡åˆ—è¡¨-æœªå‹¾é€‰
        document.getElementById("tb-task-uncheck").onclick = taskUncheckAction;
        // ä»»åŠ¡åˆ—è¡¨-å·²å‹¾é€‰
        document.getElementById("tb-task-check").onclick = taskCheckAction;
        // è¡¨æ ¼
        document.getElementById("tb-table").onclick = tableAction;
        // å›¾ç‰‡
        document.getElementById("tb-image").onclick = imageAction;
        // é“¾æ¥
        document.getElementById("tb-link").onclick = linkAction;
        // å†…åµŒä»£ç 
        document.getElementById("tb-inner-code").onclick = innerCodeAction;
        // ä»£ç å—
        document.getElementById("tb-code").onclick = codeAction;

        // ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰²ä¸‹æ‹‰èœå•
        document.getElementById("editor-color-dropdown").onclick = function(e) {
            const btn = e.target.closest(".editor-bg-color");
            if (btn) {
                const color = btn.dataset.color;
                const colorDark = btn.dataset.colorDark;
                setEditorBackgroundColor(color, colorDark);
            }
        };
    }

    /* è®¾ç½®ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰² */
    function setEditorBackgroundColor(color, darkColor) {
        const editorTextarea = document.getElementById("editor");
        const lineNumbers = document.getElementById("lineNumbers");

        editorTextarea.style.backgroundColor = color;
        lineNumbers.style.backgroundColor = color;

        // å¦‚æœæ˜¯æš—è‰²ä¸»é¢˜ï¼Œä½¿ç”¨æš—è‰²èƒŒæ™¯
        if (document.body.classList.contains("dark")) {
            editorTextarea.style.backgroundColor = darkColor;
            lineNumbers.style.backgroundColor = darkColor;
        }

        // ä¿å­˜åˆ° localStorage
        localStorage.setItem("editor_bg_color", color);
        localStorage.setItem("editor_bg_color_dark", darkColor);
    }

    /* åˆå§‹åŒ–ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰² */
    function initEditorBackgroundColor() {
        const savedColor = localStorage.getItem("editor_bg_color");
        const savedColorDark = localStorage.getItem("editor_bg_color_dark");

        if (savedColor && savedColorDark) {
            setEditorBackgroundColor(savedColor, savedColorDark);
        } else {
            // é»˜è®¤ä¸è®¾ç½®èƒŒæ™¯è‰²ï¼ˆä½¿ç”¨ CSS é»˜è®¤å€¼ï¼‰
        }
    }

    /* é¢„è§ˆå·¥å…·æ äº‹ä»¶ç»‘å®š */
    function bindPreviewToolbarEvents() {
        // å®½åº¦æ§åˆ¶
        document.getElementById("p-tb-small").onclick = function() {
            setPreviewWidth("680px", this);
        };
        document.getElementById("p-tb-middle").onclick = function() {
            setPreviewWidth("1020px", this);
        };
        document.getElementById("p-tb-large").onclick = function() {
            setPreviewWidth("1360px", this);
        };
        document.getElementById("p-tb-full").onclick = function() {
            setPreviewWidth("100%", this);
        };

        // èƒŒæ™¯é¢œè‰²
        document.getElementById("tb-color-dropdown").onclick = function(e) {
            const color = e.target.closest("[data-color]")?.dataset.color;
            if (color !== undefined) {
                preview.style.backgroundColor = color;
            }
        };

        // ä¸‹è½½å›¾ç‰‡
        document.getElementById("p-tb-download").onclick = function() {
            html2canvas(previewContentWrapper || preview, {scale: 2, useCORS: true}).then(canvas => {
                const link = document.createElement("a");
                link.download = (document.getElementById("currentFileName").textContent || "document") + ".png";
                link.href = canvas.toDataURL();
                link.click();
            });
        };

        // å…¨å±
        document.getElementById("p-tb-fullscreen").onclick = function() {
            if (document.fullscreenElement) {
                document.exitFullscreen();
            } else {
                document.documentElement.requestFullscreen();
            }
        };

        // åŒæ­¥æ»šåŠ¨
        syncScrollBtn.onclick = function() {
            isSyncScroll = !isSyncScroll;
            localStorage.setItem("syncScroll", isSyncScroll ? "true" : "false");
            syncScrollBtn.dataset.select = isSyncScroll ? "true" : "false";
        };
    }

    /* è®¾ç½®é¢„è§ˆå®½åº¦ */
    function setPreviewWidth(width, btn) {
        preview.style.maxWidth = width;
        // åŒæ—¶æ›´æ–° markdown-body çš„ max-width
        const markdownBody = document.querySelector(".markdown-body");
        markdownBody.style.maxWidth = width;

        // æ¸…é™¤æ‰€æœ‰æŒ‰é’®çš„é€‰ä¸­çŠ¶æ€
        document.querySelectorAll("#previewToolbar .btn-control").forEach(el => {
            delete el.dataset.select;
        });

        // è®¾ç½®å½“å‰æŒ‰é’®ä¸ºé€‰ä¸­
        btn.dataset.select = "true";
    }

    /* ç¼–è¾‘å·¥å…·æ æ“ä½œå‡½æ•° */
    function boldAction() {
        wrapText("**", "**");
    }

    function italicAction() {
        wrapText("*", "*");
    }

    function underlineAction() {
        wrapText("<u>", "</u>");
    }

    function strikethroughAction() {
        wrapText("~~", "~~");
    }

    function insertHeadline(level) {
        const prefix = "#".repeat(level) + " ";
        insertTextAtLineStart(prefix);
    }

    function horizontalLineAction() {
        insertTextAtLineStart("\n---\n");
    }

    function quoteAction() {
        insertTextAtLineStart("> ");
    }

    function unorderedListAction() {
        insertTextAtLineStart("- ");
    }

    function orderedListAction() {
        insertTextAtLineStart("1. ");
    }

    function taskUncheckAction() {
        insertTextAtLineStart("- [ ] ");
    }

    function taskCheckAction() {
        insertTextAtLineStart("- [x] ");
    }

    function tableAction() {
        insertTextAtLineStart("| header1 | header2 |\n|---|---|\n| row1-1 | row1-2 |\n");
    }

    function imageAction() {
        insertTextAtLineStart("![è¯´æ˜](https://img.ww135.top:23456/default.png)\n");
    }

    function linkAction() {
        insertText("[é“¾æ¥](https://)");
    }

    function innerCodeAction() {
        insertText("`code`");
    }

    function codeAction() {
        insertTextAtLineStart("```\n```\n");
    }

    /* åœ¨å…‰æ ‡ä½ç½®æ’å…¥æ–‡æœ¬ */
    function insertText(text) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const value = editor.value;
        editor.value = value.substring(0, start) + text + value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + text.length;
        editor.focus();
        updateLineNumbers();
        updateEditorFootBar();
        debouncedRender();  // ä½¿ç”¨é˜²æŠ–æ¸²æŸ“
    }

    /* åŒ…å›´é€‰ä¸­æ–‡æœ¬ */
    function wrapText(before, after) {
        const start = editor.selectionStart;
        const end = editor.selectionEnd;
        const value = editor.value;
        const selected = value.substring(start, end);
        editor.value = value.substring(0, start) + before + selected + after + value.substring(end);
        editor.selectionStart = editor.selectionEnd = start + before.length + selected.length;
        editor.focus();
        updateLineNumbers();
        updateEditorFootBar();
        render();
    }

    /* åœ¨è¡Œé¦–æ’å…¥æ–‡æœ¬ */
    function insertTextAtLineStart(text) {
        const value = editor.value;
        const start = editor.selectionStart;
        let lineStart = start;
        while (lineStart > 0 && value[lineStart - 1] !== "\n") {
            lineStart--;
        }
        editor.value = value.substring(0, lineStart) + text + value.substring(lineStart);
        const newPos = lineStart + text.length;
        editor.selectionStart = editor.selectionEnd = newPos;
        editor.focus();
        updateLineNumbers();
        updateEditorFootBar();
        render();
    }

    /* è‡ªåŠ¨ä¿å­˜ */
    editor.value = localStorage.getItem("md_content") || editor.value;

    // é˜²æŠ–æ¸²æŸ“ï¼ˆ300ms å»¶è¿Ÿï¼‰
    const debouncedRender = debounce(function() {
        render();
        updatePreviewFootBar();
    }, 300);

    editor.addEventListener("input", () => {
        localStorage.setItem("md_content", editor.value);
        updateLineNumbers();
        updateEditorFootBar();
        debouncedRender();  // ä½¿ç”¨é˜²æŠ–æ¸²æŸ“
    });

    // ç¼–è¾‘å™¨æ»šåŠ¨äº‹ä»¶ - åŒæ­¥è¡Œå·å’Œé¢„è§ˆ
    editor.addEventListener("scroll", () => {
        // è¡Œå·æ»šåŠ¨åŒæ­¥
        lineNumbers.scrollTop = editor.scrollTop;

        // é¢„è§ˆåŒºæ»šåŠ¨åŒæ­¥
        if (isSyncScroll && previewContentWrapper) {
            const scrollPercent = editor.scrollTop / (editor.scrollHeight - editor.clientHeight);
            previewContentWrapper.scrollTop = scrollPercent * (previewContentWrapper.scrollHeight - previewContentWrapper.clientHeight);
        }
    });

    // ç¼–è¾‘å™¨å…‰æ ‡ä½ç½®æ›´æ–°
    const debouncedUpdateCursorInfo = debounce(updateCursorInfo, 50);
    editor.addEventListener("keyup", debouncedUpdateCursorInfo);
    editor.addEventListener("mouseup", debouncedUpdateCursorInfo);

    // ç¼–è¾‘å™¨å¿«æ·é”®
    editor.addEventListener("keydown", function(e) {
        const ctrl = e.ctrlKey;
        const shift = e.shiftKey;

        if (ctrl && e.key === "b") {
            e.preventDefault();
            boldAction();
        } else if (ctrl && e.key === "i") {
            e.preventDefault();
            italicAction();
        } else if (ctrl && e.key === "u") {
            e.preventDefault();
            underlineAction();
        } else if (ctrl && shift && e.key === "S") {
            e.preventDefault();
            strikethroughAction();
        } else if (ctrl && e.key >= "1" && e.key <= "6") {
            e.preventDefault();
            insertHeadline(parseInt(e.key));
        } else if (ctrl && shift && e.key === "Q") {
            e.preventDefault();
            quoteAction();
        } else if (ctrl && shift && e.key === "[") {
            e.preventDefault();
            unorderedListAction();
        } else if (ctrl && shift && e.key === "]") {
            e.preventDefault();
            orderedListAction();
        } else if (ctrl && shift && e.key === "T") {
            e.preventDefault();
            tableAction();
        }
    });

    /* æ¸²æŸ“ */
    function render() {
        preview.innerHTML = marked.parse(editor.value, {breaks: true});
        generateTOC();
        preview.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
        renderMathInElement(preview, {
            delimiters: [{left: "$$", right: "$$", display: true}, {
                left: "$",
                right: "$",
                display: false
            }]
        });
        renderMermaid();
    }

    render();

    /* è®¾ç½®é€‰ä¸­è¡Œå·ï¼ˆé¿å…é‡å¤æ“ä½œï¼‰ */
    function setSelectedLineNumber(line) {
        if (line === selectedLineNumber) {
            return;
        }
        if (line == null) {
            return;
        }
        const selected = lineNumbers.querySelector(".selected");
        if (selected != null) {
            selected.classList.remove("selected");
        }
        selectedLineNumber = line;
        if (lineNumbers.children[line - 1]) {
            lineNumbers.children[line - 1].classList.add("selected");
        }
    }

    /* æ›´æ–°è¡Œå· */
    function updateLineNumbers() {
        const lines = editor.value.split("\n").length;
        if (lines === lineNumberCounter) {
            return;
        }
        while (lines !== lineNumberCounter) {
            if (lines > lineNumberCounter) {
                lineNumberCounter++;
                const span = document.createElement("span");
                span.textContent = lineNumberCounter;
                lineNumbers.appendChild(span);
            } else if (lines < lineNumberCounter) {
                lineNumberCounter--;
                lineNumbers.removeChild(lineNumbers.lastChild);
            }
        }
    }

    /* æ›´æ–°ç¼–è¾‘å™¨åº•éƒ¨çŠ¶æ€æ  */
    function updateEditorFootBar() {
        document.getElementById("charCount").textContent = editor.value.length;
        document.getElementById("lineCount").textContent = editor.value.split("\n").length;
        updateCursorInfo();
    }

    /* æ›´æ–°å…‰æ ‡ä½ç½®ä¿¡æ¯ */
    function updateCursorInfo() {
        const value = editor.value;
        const cursorPos = editor.selectionStart;
        // è®¡ç®—å…‰æ ‡æ‰€åœ¨çš„è¡Œå’Œåˆ—
        let cursorRow = 1, cursorCol = 0;
        if (cursorPos > 0) {
            cursorRow = value.substring(0, cursorPos).split("\n").length;
            cursorCol = cursorPos - value.lastIndexOf("\n", cursorPos - 1) - 1;
        }
        document.getElementById("cursorLine").textContent = cursorRow;
        document.getElementById("cursorCol").textContent = cursorCol;

        setSelectedLineNumber(cursorRow);
    }

    /* æ›´æ–°é¢„è§ˆåŒºåº•éƒ¨çŠ¶æ€æ  */
    function updatePreviewFootBar() {
        document.getElementById("headCount").textContent =
            preview.querySelectorAll("h1,h2,h3,h4,h5,h6").length;
        document.getElementById("paraCount").textContent =
            preview.querySelectorAll("p").length;
        document.getElementById("codeCount").textContent =
            preview.querySelectorAll("pre").length;
        document.getElementById("imgCount").textContent =
            preview.querySelectorAll("img").length;
    }

    // åˆå§‹åŒ–
    updateLineNumbers();
    updateEditorFootBar();
    initEditorBackgroundColor();

    // åˆå§‹åŒ–é¢„è§ˆå®½åº¦ï¼ˆé»˜è®¤ 1020pxï¼Œé€‰ä¸­ M æŒ‰é’®ï¼‰
    const middleBtn = document.getElementById("p-tb-middle");
    if (middleBtn) {
        setPreviewWidth("1020px", middleBtn);
    }

    // ä¿®æ”¹ render å‡½æ•°ä»¥æ›´æ–°é¢„è§ˆçŠ¶æ€æ 
    const originalRender = render;
    render = function() {
        originalRender();
    };

    /* Mermaid */
    function renderMermaid() {
        preview.querySelectorAll("code.language-mermaid").forEach(el => {
            const parent = el.parentElement;
            const div = document.createElement("div");
            div.className = "mermaid";
            div.innerHTML = el.textContent;
            parent.replaceWith(div);
        });
        mermaid.init(undefined, preview.querySelectorAll(".mermaid"));
    }

    /* TOC */
    function generateTOC() {
        toc.innerHTML = "";
        const headers = preview.querySelectorAll("h1,h2,h3,h4,h5,h6");
        headers.forEach((h, index) => {
            const level = parseInt(h.tagName[1]);
            const id = "heading-" + index;
            h.id = id;

            const item = document.createElement("div");
            item.className = "toc-item";
            item.dataset.level = level;
            item.textContent = h.innerText;
            item.onclick = function() {
                h.scrollIntoView({behavior: 'smooth', block: 'start'});
            };
            toc.appendChild(item);
        });
    }

    /* ç›®å½•æ˜¾ç¤º/éšè— */
    function toggleTOC() {
        isTOCVisible = !isTOCVisible;
        if (isTOCVisible) {
            toc.classList.remove("toc-hidden");
        } else {
            toc.classList.add("toc-hidden");
        }
    }

    /* æ¨¡å¼åˆ‡æ¢ */
    function toggleMode() {
        const modeBtn = document.getElementById("modeBtn");
        if (currentMode === "edit") {
            currentMode = "preview";
            modeBtn.textContent = "âœï¸ ç¼–è¾‘";
            setPreviewMode();
        } else {
            currentMode = "edit";
            modeBtn.textContent = "ğŸ‘ é¢„è§ˆ";
            setEditMode();
        }
    }

    function setEditMode() {
        const editorContainer = document.querySelector(".editor-container");
        editorContainer.style.display = "flex";
        editorContainer.style.width = "30%";
        editorContainer.style.minHeight = "0";
        const previewWrapper = document.querySelector(".preview-wrapper");
        previewWrapper.style.display = "flex";
        previewWrapper.style.width = "70%";
        previewWrapper.style.minHeight = "0";
        const resizerContainer = document.querySelector(".resizer-container");
        resizerContainer.style.display = "flex";
    }

    function setPreviewMode() {
        const editorContainer = document.querySelector(".editor-container");
        editorContainer.style.display = "none";
        const previewWrapper = document.querySelector(".preview-wrapper");
        previewWrapper.style.display = "flex";
        previewWrapper.style.width = "100%";
        previewWrapper.style.minHeight = "0";
        const resizerContainer = document.querySelector(".resizer-container");
        resizerContainer.style.display = "none";
    }

    /* ä¸»é¢˜ */
    function changeTheme(theme) {
        const body = document.body;
        const mdTheme = document.getElementById("markdownTheme");
        const codeTheme = document.getElementById("codeTheme");
        body.classList.remove("dark");
        if (theme === "dark") {
            body.classList.add("dark");
            mdTheme.href = "https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown-dark.min.css";
            codeTheme.href = "https://cdn.jsdelivr.net/npm/highlight.js/styles/github-dark.min.css";
        } else if (theme === "solarized") {
            mdTheme.href = "https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css";
            codeTheme.href = "https://cdn.jsdelivr.net/npm/highlight.js/styles/solarized-light.min.css";
        } else {
            mdTheme.href = "https://cdn.jsdelivr.net/npm/github-markdown-css/github-markdown.min.css";
            codeTheme.href = "https://cdn.jsdelivr.net/npm/highlight.js/styles/github.min.css";
        }

        // æ›´æ–°ç¼–è¾‘å™¨èƒŒæ™¯é¢œè‰²
        const savedColor = localStorage.getItem("editor_bg_color");
        const savedColorDark = localStorage.getItem("editor_bg_color_dark");
        if (savedColor && savedColorDark) {
            setEditorBackgroundColor(savedColor, savedColorDark);
        }
    }

    /* æ‹–åŠ¨åˆ†éš” */
    const resizerMid = document.querySelector("#resizerMid");
    const resizerTop = document.querySelector("#resizerTop");
    const resizerBottom = document.querySelector("#resizerBottom");
    const resizerTopIcon = document.querySelector("#resizerTopIcon");
    const resizerBottomIcon = document.querySelector("#resizerBottomIcon");
    let isDragging = false;
    let isPreviewCollapsed = false;
    let isFootBarHidden = false;
    let startX = 0;
    let startPercent = 0;

    // ä¸­é—´æ‹–åŠ¨åŒºåŸŸ - è°ƒæ•´å¤§å°
    resizerMid.addEventListener("mousedown", function (e) {
        isDragging = true;
        startX = e.clientX;
        const editorContainer = document.querySelector(".editor-container");
        startPercent = parseFloat(editorContainer.style.width) || 30;
        document.body.classList.add("no-select");
        document.body.classList.add("resizing");
        document.addEventListener("mousemove", resize);
        document.addEventListener("mouseup", stopResize);
    });

    // é¡¶éƒ¨æŒ‰é’® - æŠ˜å /å±•å¼€é¢„è§ˆ
    resizerTop.addEventListener("click", function() {
        isPreviewCollapsed = !isPreviewCollapsed;
        const previewWrapper = document.querySelector(".preview-wrapper");
        const editorContainer = document.querySelector(".editor-container");

        if (isPreviewCollapsed) {
            // æŠ˜å é¢„è§ˆ
            editorContainer.style.width = "100%";
            editorContainer.style.minHeight = "0";
            previewWrapper.style.width = "0%";
            previewWrapper.style.minHeight = "0";
            previewWrapper.style.display = "none";
            // æ”¹å˜å›¾æ ‡ä¸ºå‘å·¦
            resizerTopIcon.className = "bi bi-caret-left";
        } else {
            // å±•å¼€é¢„è§ˆ
            editorContainer.style.width = "50%";
            editorContainer.style.minHeight = "0";
            previewWrapper.style.width = "50%";
            previewWrapper.style.minHeight = "0";
            previewWrapper.style.display = "flex";
            // æ”¹å˜å›¾æ ‡ä¸ºå‘å³
            resizerTopIcon.className = "bi bi-caret-right";
        }
    });

    // åº•éƒ¨æŒ‰é’® - éšè—/æ˜¾ç¤ºçŠ¶æ€æ 
    resizerBottom.addEventListener("click", function() {
        isFootBarHidden = !isFootBarHidden;

        // åŒæ—¶éšè—/æ˜¾ç¤ºç¼–è¾‘å™¨å’Œé¢„è§ˆåŒºåŸŸçš„åº•éƒ¨çŠ¶æ€æ 
        const editorFootBar = document.querySelector(".editor-container .foot-bar");
        const previewFootBar = document.querySelector(".preview-wrapper .foot-bar");

        if (isFootBarHidden) {
            editorFootBar.style.display = "none";
            previewFootBar.style.display = "none";
            // æ”¹å˜å›¾æ ‡ä¸ºå‘ä¸Š
            resizerBottomIcon.className = "bi bi-chevron-up";
        } else {
            editorFootBar.style.display = "flex";
            previewFootBar.style.display = "flex";
            // æ”¹å˜å›¾æ ‡ä¸ºå‘ä¸‹
            resizerBottomIcon.className = "bi bi-chevron-down";
        }
    });

    function stopResize() {
        isDragging = false;
        document.body.classList.remove("no-select");
        document.body.classList.remove("resizing");
        document.removeEventListener("mousemove", resize);
        document.removeEventListener("mouseup", stopResize);
    }

    function resize(e) {
        if (!isDragging) return;

        // ç¡®ä¿ä¸åœ¨é¡¶éƒ¨æŒ‰é’®å’Œåº•éƒ¨æŒ‰é’®çš„åŒºåŸŸå†…æ‹–åŠ¨
        const resizerContainer = document.querySelector(".resizer-container");
        const resizerRect = resizerContainer.getBoundingClientRect();

        // å¦‚æœé¼ æ ‡åœ¨é¡¶éƒ¨ 36px æˆ–åº•éƒ¨ 24px èŒƒå›´å†…ï¼Œä¸æ‹–åŠ¨
        if (e.clientY <= resizerRect.top + 36 || e.clientY >= resizerRect.bottom - 24) {
            return;
        }

        const container = document.querySelector(".container");
        const containerRect = container.getBoundingClientRect();
        const tocWidth = isTOCVisible ? toc.offsetWidth : 0;
        const mouseX = e.clientX - containerRect.left - tocWidth;
        const availableWidth = container.offsetWidth - tocWidth;
        const newPercent = Math.max(10, Math.min(90, (mouseX / availableWidth) * 100));
        const editorContainer = document.querySelector(".editor-container");
        const previewWrapper = document.querySelector(".preview-wrapper");

        editorContainer.style.width = newPercent + "%";
        editorContainer.style.minHeight = "0";
        previewWrapper.style.width = (100 - newPercent) + "%";
        previewWrapper.style.minHeight = "0";
    }

    /* æ‰“å¼€æ–‡ä»¶ */
    async function openFile() {
        try {
            const [fileHandle] = await window.showOpenFilePicker({
                types: [{
                    description: 'Markdownæ–‡ä»¶',
                    accept: {'text/markdown': ['.md']}
                }],
                multiple: false
            });
            
            currentFileHandle = fileHandle;
            const file = await fileHandle.getFile();
            const contents = await file.text();
            
            editor.value = contents;
            updateFileName(file.name);
            render();
            showToast('æ‰“å¼€æ–‡ä»¶æˆåŠŸï¼');
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('æ‰“å¼€æ–‡ä»¶å¤±è´¥:', err);
                showToast('æ‰“å¼€æ–‡ä»¶å¤±è´¥', 'error');
            }
        }
    }

    /* æ‹–æ‹½æ’å…¥å›¾ç‰‡ */
    editor.addEventListener("dragover", e => e.preventDefault());
    editor.addEventListener("drop", e => {
        e.preventDefault();
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith("image/")) {
            const reader = new FileReader();
            reader.onload = ev => {
                editor.value += "\n![](" + ev.target.result + ")\n";
                render();
            };
            reader.readAsDataURL(file);
        }
    });

    /* ä¿å­˜ */
    async function saveFile() {
        if (currentFileHandle) {
            const writable = await currentFileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            updateFileName(currentFileHandle.name);
            showToast('ä¿å­˜æˆåŠŸï¼');
        } else {
            await saveAs();
        }
    }

    async function saveAs() {
        try {
            currentFileHandle = await window.showSaveFilePicker({
                suggestedName: "document.md",
                types: [{
                    description: 'Markdownæ–‡ä»¶',
                    accept: {'text/markdown': ['.md']}
                }]
            });
            const writable = await currentFileHandle.createWritable();
            await writable.write(editor.value);
            await writable.close();
            updateFileName(currentFileHandle.name);
            showToast('ä¿å­˜æˆåŠŸï¼');
        } catch (err) {
            if (err.name !== 'AbortError') {
                console.error('ä¿å­˜å¤±è´¥:', err);
                showToast('ä¿å­˜å¤±è´¥', 'error');
            }
        }
    }

    /* æ›´æ–°æ–‡ä»¶åæ˜¾ç¤º */
    function updateFileName(name) {
        const fileNameSpan = document.getElementById("currentFileName");
        fileNameSpan.textContent = name;
    }

    /* Toastæç¤º */
    function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        toast.textContent = message;
        toast.className = 'toast ' + type;
        toast.classList.add('show');

        setTimeout(() => {
            toast.classList.remove('show');
        }, 2000);
    }

    /* æ–°å»ºæ–‡ä»¶ */
    function newFile() {
        if (confirm('æ–°å»ºæ–‡ä»¶å°†æ¸…ç©ºå½“å‰å†…å®¹ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ')) {
            editor.value = "";
            currentFileHandle = null;
            localStorage.setItem("md_content", "");
            updateFileName("æœªå‘½åæ–‡ä»¶");
            render();
        }
    }

    /* PDF */
    function exportPDF() {
        const fileName = document.getElementById("currentFileName").textContent;
        const pdfFileName = fileName.replace(/\.md$/, '') + '.pdf';
        
        const opt = {
            margin:       [15, 15, 15, 15],
            filename:     pdfFileName,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { 
                scale: 2,
                useCORS: true,
                letterRendering: true
            },
            jsPDF:        { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait' 
            },
            pagebreak:    { mode: ['avoid-all', 'css', 'legacy'] }
        };
        
        html2pdf().set(opt).from(preview).save();
    }

    /* æ‰“å° */
    function printDocument() {
        window.print();
    }

    let editorFontSize = 16;

    function increaseFontSize() {
        editorFontSize = Math.min(editorFontSize + 2, 32);
        editor.style.fontSize = editorFontSize + 'px';
        lineNumbers.style.fontSize = editorFontSize + 'px';
    }

    function decreaseFontSize() {
        editorFontSize = Math.max(editorFontSize - 2, 10);
        editor.style.fontSize = editorFontSize + 'px';
        lineNumbers.style.fontSize = editorFontSize + 'px';
    }

    /* å¿«æ·é”®ç›‘å¬ */
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 's') {
            e.preventDefault();
            saveFile();
        }
    });
</script>
</body>
</html>