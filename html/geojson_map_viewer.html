<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GeoJSON åœ°å›¾æ¸²æŸ“å·¥å…·</title>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        /* å…¨å±€æ ·å¼ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* ä¸Šä¼ åŒºåŸŸæ ·å¼ */
        .uploader {
            position: fixed;
            width: 268px;
            top: 5px;
            left: 5px;
            z-index: 1000;
        }

        .drop-zone {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px 15px;
            text-align: center;
            transition: all 0.3s ease;
            background-color: white;
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.08);
        }

        .drop-zone:hover {
            border-color: #4a90e2;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
        }

        .drop-zone.highlight {
            border-color: #4a90e2;
            background-color: #f0f7ff;
            box-shadow: 0 2px 10px rgba(74, 144, 226, 0.15);
        }

        .drop-zone-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .drop-zone-icon {
            font-size: 32px;
            margin-bottom: 5px;
        }

        .drop-zone h3 {
            margin: 0;
            font-size: 18px;
            color: #333;
            font-weight: 600;
        }

        .drop-zone p {
            margin: 0;
            color: #666;
            font-size: 14px;
        }

        .file-select-btn {
            display: inline-block;
            background-color: #4a90e2;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .file-select-btn:hover {
            background-color: #357abd;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
            transform: translateY(-1px);
        }

        .file-info {
            font-size: 14px;
            color: #999;
            margin-top: 10px;
        }

        .selected-file-name {
            font-size: 13px;
            color: #4a90e2;
            margin-top: 8px;
            padding: 6px 12px;
            background-color: rgba(74, 144, 226, 0.1);
            border-radius: 4px;
            border: 1px solid rgba(74, 144, 226, 0.2);
            width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* åœ°å›¾å®¹å™¨æ ·å¼ */
        #main {
            flex: 1;
            width: 100%;
            background-color: white;
            overflow: hidden;
        }

        /* å±æ€§è¾“å‡ºåŒºåŸŸæ ·å¼ */
        #output {
            position: fixed;
            left: 20px;
            bottom: 20px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            max-width: 500px;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 14px;
            line-height: 1.6;
        }
        #output span{
            font-size: 13px;
            color: #999;
        }
        #output pre{
            margin-block: 5px;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        #output::-webkit-scrollbar {
            width: 8px;
        }

        #output::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        #output::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }

        #output::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* è¦ç´ æ•°é‡æ ‡ç­¾æ ·å¼ */
        .feature-count-label {
            position: fixed;
            bottom: 20px;
            right: 20px;
            font-size: 13px;
            color: #666;
            z-index: 1000;
            pointer-events: none;
        }

        /* åœ°å›¾é…ç½®é¢æ¿æ ·å¼ */
        #mapConfigPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1001;
            transform: translateX(150%);
            transition: transform 0.3s ease;
        }

        #mapConfigPanel.show {
            transform: translateX(0);
        }

        .panel-header {
            background-color: #f5f5f5;
            padding: 15px;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ddd;
        }

        .panel-header h3 {
            margin: 0;
            font-size: 16px;
            color: #333;
        }


        .icon-button {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #666;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-button:hover {
            color: #000;
        }

        .reset-button {
            margin-left: auto;
            margin-right: 10px;
            padding-top: 3px;
        }

        .panel-content {
            padding: 15px;
        }

        .config-item {
            margin-bottom: 15px;
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .config-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #333;
        }

        .config-item input[type="color"] {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            border-radius: 4px;
            cursor: pointer;
        }

        .config-item input[type="number"] {
            width: 60px;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .config-item select {
            flex: 1;
            padding: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .apply-button {
            width: 100%;
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }

        .apply-button:hover {
            background-color: #1976D2;
        }

        /* é…ç½®é¢æ¿åˆ‡æ¢æŒ‰é’® */
        #toggleConfigPanel {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            font-size: 18px;
            color: #666;
        }

        #toggleConfigPanel:hover {
            background-color: #f5f5f5;
            color: #333;
        }
    </style>
</head>

<body>
<div class="uploader">
    <div id="dropZone" class="drop-zone">
        <div class="drop-zone-content">
            <div class="drop-zone-icon">ğŸ“</div>
            <h3>æ‹–æ‹½ GeoJSON æ–‡ä»¶åˆ°æ­¤å¤„</h3>
            <p>æˆ–</p>
            <label for="geojsonFile" class="file-select-btn">
                é€‰æ‹©æ–‡ä»¶
                <input type="file" id="geojsonFile" accept=".json, .geojson" style="display: none;">
            </label>
            <p class="file-info">æ”¯æŒ .geojson å’Œ .json æ ¼å¼æ–‡ä»¶</p>
            <div id="selectedFileName" class="selected-file-name">è¯·é€‰æ‹©æ–‡ä»¶</div>
        </div>
    </div>
</div>
<!-- é…ç½®é¢æ¿åˆ‡æ¢æŒ‰é’® -->
<button id="toggleConfigPanel">âš™</button>

<!-- åœ°å›¾å±æ€§é…ç½®é¢æ¿ -->
<div id="mapConfigPanel">
    <div class="panel-header">
        <h3>åœ°å›¾å±æ€§é…ç½®</h3>
        <button id="resetConfig" class="icon-button reset-button" title="é‡ç½®ä¸ºé»˜è®¤å€¼">âŸ²</button>
        <button id="closePanel" class="icon-button" title="å…³é—­é¢æ¿">âœ•</button>

    </div>
    <div class="panel-content">
        <div class="config-item">
            <label>
                <input type="checkbox" id="showTitle" checked> æ˜¾ç¤ºæ ‡é¢˜
            </label>
        </div>
        <div class="config-item">
            <label>
                <input type="checkbox" id="showLabels" checked> æ˜¾ç¤ºåœ°å›¾æ ‡ç­¾
            </label>
        </div>
        <div class="config-item">
            <label for="labelProperty">æ ‡ç­¾æ˜¾ç¤ºå±æ€§:</label>
            <select id="labelProperty" style="flex:1; padding:5px; border:1px solid #ddd; border-radius:4px;">
                <option value="name">nameï¼ˆé»˜è®¤ï¼‰</option>
            </select>
        </div>
        <div class="config-item">
            <label for="labelFontSize">æ ‡ç­¾å­—ä½“å¤§å°:</label>
            <input type="number" id="labelFontSize" min="8" max="32" value="13">PX
        </div>

        <div class="config-item">
            <label>
                <input type="checkbox" id="showTooltip" checked> æ˜¾ç¤ºæ‚¬æµ®æç¤º
            </label>
        </div>

        <div class="config-item">
            <label>
                <input type="checkbox" id="allowZoom" checked> å…è®¸ç¼©æ”¾
            </label>
        </div>
        <div class="config-item">
            <label for="aspectScale">å®½é«˜æ¯”è°ƒæ•´:</label>
            <input type="number" id="aspectScale" min="0.1" max="3.0" step="0.1" value="1.0">
        </div>
        <div class="config-item">
            <label for="containerBgColor">å®¹å™¨èƒŒæ™¯è‰²:</label>
            <input type="color" id="containerBgColor" value="#ffffff">
            <span class="color-value" id="containerBgColorValue">#ffffff</span>
        </div>

        <div class="config-item">
            <label for="fillColor">å¡«å……é¢œè‰²:</label>
            <input type="color" id="fillColor" value="#c4e3f3">
            <span class="color-value" id="fillColorValue">#c4e3f3</span>
        </div>
        <div class="config-item">
            <label for="borderColor">è¾¹æ¡†é¢œè‰²:</label>
            <input type="color" id="borderColor" value="#4682b4">
            <span class="color-value" id="borderColorValue">#4682b4</span>
        </div>
        <div class="config-item">
            <label for="borderWidth">è¾¹æ¡†å®½åº¦:</label>
            <input type="number" id="borderWidth" min="0" max="10" value="1">PX
        </div>
        <div class="config-item">
            <label for="hoverColor">é¼ æ ‡æ‚¬åœé¢œè‰²:</label>
            <input type="color" id="hoverColor" value="#ffa500">
            <span class="color-value" id="hoverColorValue">#ffa500</span>
        </div>
        <div class="config-item">
            <label for="selectColor">é€‰ä¸­é¢œè‰²:</label>
            <input type="color" id="selectColor" value="#ff4444">
            <span class="color-value" id="selectColorValue">#ff4444</span>
        </div>
        <button id="applyConfig" class="apply-button">åº”ç”¨é…ç½®</button>
    </div>
</div>

<!-- åœ°å›¾å®¹å™¨ -->
<div id="main"></div>
<div id="output">ç‚¹å‡»åœ°å›¾ï¼Œå±æ€§å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ</div>
<div id="featureCountLabel" class="feature-count-label"></div>

<script>
    // ä½¿ç”¨IIFEå°è£…ï¼Œé¿å…æ±¡æŸ“å…¨å±€ä½œç”¨åŸŸ
    (function () {
        // ---------------------- å¸¸é‡å’Œé…ç½® ----------------------
        const defaultConfig = {
            showTitle: true,
            showLabels: true,
            showTooltip: true,
            labelProperty: 'name',
            allowZoom: true,
            aspectScale: 1.0,
            labelFontSize: 13,
            borderWidth: 1,
            fillColor: '#c4e3f3',
            borderColor: '#4682b4',
            hoverColor: '#ffa500',
            selectColor: '#ff4444',
            containerBgColor: '#ffffff'
        };

        // ---------------------- å…¨å±€å˜é‡ ----------------------
        let myChart = null;
        let geoJson = null;

        // ---------------------- DOMå…ƒç´ ç¼“å­˜ ----------------------
        const domElements = {
            // åœ°å›¾å®¹å™¨
            chartDom: document.getElementById('main'),
            output: document.getElementById('output'),
            featureCountLabel: document.getElementById('featureCountLabel'),

            // ä¸Šä¼ åŒºåŸŸ
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('geojsonFile'),
            selectedFileName: document.getElementById('selectedFileName'),

            // é…ç½®é¢æ¿
            configPanel: document.getElementById('mapConfigPanel'),
            toggleConfigPanel: document.getElementById('toggleConfigPanel'),
            closePanel: document.getElementById('closePanel'),
            resetConfig: document.getElementById('resetConfig'),
            applyConfig: document.getElementById('applyConfig'),

            // é…ç½®é¡¹
            showTitle: document.getElementById('showTitle'),
            showLabels: document.getElementById('showLabels'),
            showTooltip: document.getElementById('showTooltip'),
            allowZoom: document.getElementById('allowZoom'),
            labelFontSize: document.getElementById('labelFontSize'),
            borderWidth: document.getElementById('borderWidth'),
            labelProperty: document.getElementById('labelProperty'),
            aspectScale: document.getElementById('aspectScale'),

            // é¢œè‰²é…ç½®
            colors: {
                fillColor: {
                    input: document.getElementById('fillColor'),
                    value: document.getElementById('fillColorValue')
                },
                borderColor: {
                    input: document.getElementById('borderColor'),
                    value: document.getElementById('borderColorValue')
                },
                hoverColor: {
                    input: document.getElementById('hoverColor'),
                    value: document.getElementById('hoverColorValue')
                },
                selectColor: {
                    input: document.getElementById('selectColor'),
                    value: document.getElementById('selectColorValue')
                },
                containerBgColor: {
                    input: document.getElementById('containerBgColor'),
                    value: document.getElementById('containerBgColorValue')
                }
            }
        };

        // ---------------------- åœ°å›¾åˆå§‹åŒ– ----------------------
        function initMap() {
            // åˆå§‹åŒ–EChartså®ä¾‹
            myChart = echarts.init(domElements.chartDom);

            //åœ°å›¾é€‰ä¸­äº‹ä»¶
            myChart.on('select', function (params) {
                // console.log('é€‰ä¸­åœ°å›¾è¦ç´ :', params);
                const dataIndexInside = params.dataIndexInside;
                if(geoJson && geoJson.features && geoJson.features[dataIndexInside]){
                    const feature = geoJson.features[dataIndexInside];
                    const properties = feature.properties;
                    let html = `<b>`;
                    html += properties[domElements.labelProperty.value] || properties.name ;
                    html += ` å±æ€§</b><br>`;

                    html += `<span>index: ${dataIndexInside}</span>`;

                    html += `<pre>`;
                    html += JSON.stringify(properties, null, 2);
                    html += `</pre>`;
                    
                    domElements.output.innerHTML = html;
                }else {
                    domElements.output.innerHTML = `<p>æœªæ‰¾åˆ°å±æ€§ä¿¡æ¯</p>`;
                }
            });
            // åœ°å›¾å–æ¶ˆé€‰ä¸­äº‹ä»¶
            myChart.on('unselect', function (params) {
                // console.log('å–æ¶ˆé€‰ä¸­åœ°å›¾è¦ç´ :', params);
                domElements.output.innerHTML = 'ç‚¹å‡»åœ°å›¾ï¼Œå±æ€§å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ';
            });

            // åœ°å›¾ç‚¹å‡»äº‹ä»¶ - æ˜¾ç¤ºå±æ€§ä¿¡æ¯
            // myChart.on('click', function (params) {
            //     console.log('ç‚¹å‡»åœ°å›¾:', params);
            //     //è¿™é‡Œå¯ä»¥è·å–åˆ°params.data
            // });

            // çª—å£å¤§å°å˜åŒ–æ—¶é‡ç»˜åœ°å›¾
            window.addEventListener('resize', function () {
                myChart.resize();
            });
        }

        // ---------------------- é…ç½®ç®¡ç† ----------------------
        function loadConfigFromLocalStorage() {
            try {
                const savedConfig = localStorage.getItem('mapConfig');
                if (savedConfig) {
                    const config = JSON.parse(savedConfig);

                    // åº”ç”¨å¸ƒå°”é€‰é¡¹
                    domElements.showTitle.checked = config.showTitle;
                    domElements.showLabels.checked = config.showLabels;
                    domElements.showTooltip.checked = config.showTooltip;
                    domElements.allowZoom.checked = config.allowZoom;
                    domElements.labelFontSize.value = config.labelFontSize || defaultConfig.labelFontSize;
                    domElements.borderWidth.value = config.borderWidth || defaultConfig.borderWidth;
                    domElements.labelProperty.value = config.labelProperty || defaultConfig.labelProperty;
                    domElements.aspectScale.value = config.aspectScale || defaultConfig.aspectScale;

                    // åº”ç”¨é¢œè‰²é…ç½®
                    Object.keys(domElements.colors).forEach(colorKey => {
                        const colorEl = domElements.colors[colorKey];
                        if (colorEl.input && colorEl.value) {
                            const colorValue = config[colorKey] || defaultConfig[colorKey];
                            colorEl.input.value = colorValue;
                            colorEl.value.textContent = colorValue;
                        }
                    });

                    // ç›´æ¥åº”ç”¨å®¹å™¨èƒŒæ™¯è‰²
                    updateContainerBgColor(config.containerBgColor || defaultConfig.containerBgColor);
                }
            } catch (e) {
                console.warn('æ— æ³•ä»localStorageåŠ è½½é…ç½®:', e);
            }
        }

        function saveConfigToLocalStorage(config) {
            localStorage.setItem('mapConfig', JSON.stringify(config));
        }

        function resetConfig() {
            // é‡ç½®ä¸ºé»˜è®¤é…ç½®
            domElements.showTitle.checked = defaultConfig.showTitle;
            domElements.showLabels.checked = defaultConfig.showLabels;
            domElements.showTooltip.checked = defaultConfig.showTooltip;
            domElements.allowZoom.checked = defaultConfig.allowZoom;
            domElements.labelFontSize.value = defaultConfig.labelFontSize;
            domElements.borderWidth.value = defaultConfig.borderWidth;
            domElements.labelProperty.value = defaultConfig.labelProperty;
            domElements.aspectScale.value = defaultConfig.aspectScale;

            // é‡ç½®é¢œè‰²é…ç½®
            Object.keys(domElements.colors).forEach(colorKey => {
                const colorEl = domElements.colors[colorKey];
                if (colorEl.input && colorEl.value) {
                    colorEl.input.value = defaultConfig[colorKey];
                    colorEl.value.textContent = defaultConfig[colorKey];
                }
            });

            // åº”ç”¨é‡ç½®åçš„é…ç½®
            applyMapConfig();
        }

        // ---------------------- æ–‡ä»¶ä¸Šä¼ å¤„ç† ----------------------
        function initFileUpload() {
            // æ‹–æ‹½äº‹ä»¶
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                domElements.dropZone.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                domElements.dropZone.addEventListener(eventName, highlight, false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                domElements.dropZone.addEventListener(eventName, unhighlight, false);
            });

            domElements.dropZone.addEventListener('drop', handleFileDrop, false);
            domElements.fileInput.addEventListener('change', handleFileSelect, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function highlight() {
            domElements.dropZone.classList.add('highlight');
        }

        function unhighlight() {
            domElements.dropZone.classList.remove('highlight');
        }

        function handleFileDrop(e) {
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processGeoJSONFile(files[0]);
            }
        }

        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processGeoJSONFile(file);
            }
            // é‡ç½®æ–‡ä»¶è¾“å…¥æ¡†ï¼Œå…è®¸è¿ç»­é€‰æ‹©ç›¸åŒçš„æ–‡ä»¶
            this.value = '';
        }

        function processGeoJSONFile(file) {
            const fileName = file.name.toLowerCase();
            const hasJsonMimeType = file && file.type && (file.type === 'application/json' || file.type === 'application/geo+json');
            const hasValidExtension = fileName.endsWith('.geojson') || fileName.endsWith('.json');

            if (!file || (!hasJsonMimeType && !hasValidExtension)) {
                alert('è¯·é€‰æ‹©æœ‰æ•ˆçš„ GeoJSON æ–‡ä»¶ï¼ˆ.geojson æˆ– .json æ ¼å¼ï¼‰');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    let geoJsonTmp = JSON.parse(e.target.result);

                    // éªŒè¯GeoJSONç»“æ„
                    if (!geoJsonTmp || !Array.isArray(geoJsonTmp.features)) {
                        throw new Error('GeoJSONæ–‡ä»¶ç»“æ„ä¸æ­£ç¡®ï¼Œç¼ºå°‘featuresæ•°ç»„');
                    }
                    // æ›¿æ¢åŸå§‹geoJsonå˜é‡
                    geoJson = geoJsonTmp;
                    console.log(`æˆåŠŸè§£æGeoJSONæ–‡ä»¶ï¼ŒåŒ…å«${geoJson.features.length}ä¸ªè¦ç´ `);

                    // æå–æ‰€æœ‰å¯ç”¨å±æ€§å¹¶å¡«å……ä¸‹æ‹‰æ¡†
                    if (geoJson.features && geoJson.features.length > 0) {
                        loadLabelProperties(geoJson.features);
                    }

                    // æ›´æ–°è¦ç´ æ•°é‡æ˜¾ç¤º
                    updateFeatureCount(geoJson.features ? geoJson.features.length : 0);
                    // æ›´æ–°æ–‡ä»¶å
                    updateSelectedFileName(file);

                    // æ¸²æŸ“åœ°å›¾
                    renderMap();
                } catch (error) {
                    console.error("åœ°å›¾æ¸²æŸ“é”™è¯¯:", error);
                    alert('åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿æ–‡ä»¶æ ¼å¼æ­£ç¡®ï¼\n\n' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // ---------------------- åœ°å›¾æ¸²æŸ“ ----------------------
        function renderMap() {
            if (!geoJson || !myChart) return;

            try {
                // æ³¨å†Œåœ°å›¾
                echarts.registerMap('customMap', geoJson);
                // æ¸…ç©ºå½“å‰å›¾è¡¨
                myChart.clear();
                // åº”ç”¨å½“å‰é…ç½®
                applyMapConfig();
            } catch (error) {
                console.error('æ¸²æŸ“åœ°å›¾å¤±è´¥:', error);
                alert('åœ°å›¾æ¸²æŸ“å¤±è´¥ï¼Œè¯·æ£€æŸ¥GeoJSONæ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®ã€‚');
            }
        }

        function applyMapConfig() {
            if (!myChart) return;

            // è·å–å½“å‰é…ç½®
            const config = getCurrentConfig();

            // ä¿å­˜é…ç½®åˆ°localStorage
            saveConfigToLocalStorage(config);

            // æ›´æ–°åœ°å›¾å®¹å™¨èƒŒæ™¯è‰²
            updateContainerBgColor(config.containerBgColor);

            // ç”Ÿæˆåœ°å›¾é…ç½®é€‰é¡¹
            const option = generateMapOption(config);

            // è®¾ç½®åœ°å›¾é…ç½®å¹¶æ¸²æŸ“
            myChart.setOption(option);
            myChart.resize();
        }

        function getCurrentConfig() {
            return {
                showTitle: domElements.showTitle.checked,
                showLabels: domElements.showLabels.checked,
                showTooltip: domElements.showTooltip.checked,
                allowZoom: domElements.allowZoom.checked,
                labelFontSize: parseInt(domElements.labelFontSize.value) || defaultConfig.labelFontSize,
                borderWidth: parseInt(domElements.borderWidth.value) || defaultConfig.borderWidth,
                fillColor: domElements.colors.fillColor.input.value || defaultConfig.fillColor,
                borderColor: domElements.colors.borderColor.input.value || defaultConfig.borderColor,
                hoverColor: domElements.colors.hoverColor.input.value || defaultConfig.hoverColor,
                selectColor: domElements.colors.selectColor.input.value || defaultConfig.selectColor,
                containerBgColor: domElements.colors.containerBgColor.input.value || defaultConfig.containerBgColor,
                labelProperty: domElements.labelProperty.value || defaultConfig.labelProperty,
                aspectScale: parseFloat(domElements.aspectScale.value) || defaultConfig.aspectScale
            };
        }

        function generateMapOption(config) {
            return {
                title: {
                    show: config.showTitle,
                    text: geoJson ? geoJson.name || 'åœ°å›¾æ¸²æŸ“' : 'åœ°å›¾æ¸²æŸ“',
                    left: 'center'
                },
                tooltip: {
                    trigger: 'item',
                    show: config.showTooltip,
                    formatter: function (params) {
                        let content = '';
                        if (params.data) {
                            content += `<strong>${params.name}</strong><br>`;
                        }
                        if (params.data && params.data.properties) {
                            for (const key in params.data.properties) {
                                content += `${key}: ${params.data.properties[key]}<br>`;
                            }
                        }
                        return content;
                    }
                },
                series: [
                    {
                        name: 'åŒºåŸŸ',
                        type: 'map',
                        map: 'customMap',
                        roam: config.allowZoom,
                        aspectScale: config.aspectScale,
                        label: {
                            show: config.showLabels,
                            fontSize: config.labelFontSize,
                            formatter: function (params) {
                                return params.data?.properties?.[config.labelProperty] || "";
                            }
                        },
                        emphasis: {
                            label: {
                                show: config.showLabels,
                                color: '#fff',
                                fontSize: config.labelFontSize,
                                formatter: function (params) {
                                    return params.data?.properties?.[config.labelProperty] || "";
                                }
                            },
                            itemStyle: {
                                areaColor: config.hoverColor
                            }
                        },
                        select: {
                            itemStyle: {
                                areaColor: config.selectColor
                            },
                            label: {
                                show: config.showLabels,
                                color: '#fff',
                                fontSize: config.labelFontSize,
                                formatter: function (params) {
                                    return params.data?.properties?.[config.labelProperty] || "";
                                }
                            }
                        },
                        itemStyle: {
                            areaColor: config.fillColor,
                            borderColor: config.borderColor,
                            borderWidth: config.borderWidth
                        },
                        data: geoJson?.features?.map(feature => ({
                            name: feature.properties?.name || feature.id || '',
                            properties: feature.properties,
                            itemStyle: feature.properties?.color ? {
                                areaColor: feature.properties.color
                            } : undefined
                        })) || []
                    }
                ]
            };
        }

        // ---------------------- è¾…åŠ©å‡½æ•° ----------------------
        function loadLabelProperties(features) {
            const propertiesSet = new Set();

            // æ”¶é›†æ‰€æœ‰featureçš„propertiesé”®å
            features.forEach(feature => {
                if (feature.properties) {
                    Object.keys(feature.properties).forEach(key => {
                        propertiesSet.add(key);
                    });
                }
            });

            // æ¸…ç©ºç°æœ‰é€‰é¡¹ï¼ˆä¿ç•™é»˜è®¤é¡¹ï¼‰
            while (domElements.labelProperty.options.length > 1) {
                domElements.labelProperty.remove(1);
            }

            // æ·»åŠ æ–°é€‰é¡¹
            Array.from(propertiesSet).forEach(prop => {
                if (prop !== 'name') {
                    const option = document.createElement('option');
                    option.value = prop;
                    option.textContent = prop;
                    domElements.labelProperty.appendChild(option);
                }
            });
        }

        function updateFeatureCount(count) {
            domElements.featureCountLabel.textContent = `è¦ç´ æ•°é‡: ${count}`;
        }

        // æ˜¾ç¤ºé€‰ä¸­çš„æ–‡ä»¶å
        function updateSelectedFileName(file) {
            domElements.selectedFileName.title = file.name;
            domElements.selectedFileName.textContent = file.name;
        }

        function updateContainerBgColor(color) {
            domElements.chartDom.style.backgroundColor = color;
        }

        function initColorListeners() {
            Object.values(domElements.colors).forEach(colorEl => {
                if (colorEl.input && colorEl.value) {
                    colorEl.input.addEventListener('input', function () {
                        colorEl.value.textContent = this.value;
                    });
                }
            });
        }

        // ---------------------- é…ç½®é¢æ¿äº¤äº’ ----------------------
        function initConfigPanel() {
            // åˆ‡æ¢é…ç½®é¢æ¿æ˜¾ç¤º/éšè—
            domElements.toggleConfigPanel.addEventListener('click', function () {
                domElements.configPanel.classList.toggle('show');
            });

            // å…³é—­é…ç½®é¢æ¿
            domElements.closePanel.addEventListener('click', function () {
                domElements.configPanel.classList.remove('show');
            });

            // é‡ç½®é…ç½®
            if (domElements.resetConfig) {
                domElements.resetConfig.addEventListener('click', resetConfig);
            }

            // åº”ç”¨é…ç½®
            if (domElements.applyConfig) {
                domElements.applyConfig.addEventListener('click', applyMapConfig);
            }

            // åˆå§‹åŒ–é¢œè‰²é€‰æ‹©å™¨ç›‘å¬
            initColorListeners();
        }

        // ---------------------- åˆå§‹åŒ–åº”ç”¨ ----------------------
        function init() {
            // åˆå§‹åŒ–åœ°å›¾
            initMap();

            // åˆå§‹åŒ–æ–‡ä»¶ä¸Šä¼ 
            initFileUpload();

            // åˆå§‹åŒ–é…ç½®é¢æ¿
            initConfigPanel();

            // åŠ è½½é…ç½®
            loadConfigFromLocalStorage();
        }

        // ---------------------- å¯åŠ¨åº”ç”¨ ----------------------
        document.addEventListener('DOMContentLoaded', init);
    })();
</script>
</body>

</html>
